#!/bin/bash
# claude-code-command-switch 核心管理脚本

set -e

INSTALL_DIR="$HOME/.claude-switch"
CONFIG_FILE="$INSTALL_DIR/models.conf"
COMMANDS_DIR="$INSTALL_DIR/commands"
BIN_DIR="$HOME/.local/bin"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# 显示帮助
show_help() {
    cat << EOF
claude-code-command-switch - 多模型命令切换工具

用法:
  claude-switch <command> [options]

命令:
  add <name>              添加新的模型命令
  remove <name>           删除模型命令
  list                    列出所有可用命令
  edit                    编辑配置文件
  init                    重新初始化配置
  update                  更新到最新版本
  help                    显示此帮助信息

示例:
  claude-switch add glm                    # 添加 claude-glm 命令
  claude-switch list                       # 查看所有命令
  claude-glm "帮我写一个 Python 脚本"     # 使用 glm 模型

配置文件: ~/.claude-switch/models.conf

配置文件格式:
  COMMAND_NAME|MODEL_ID|API_ENDPOINT|API_KEY_ENV_VAR|DESCRIPTION

示例配置:
  claude-glm|glm-4|https://open.bigmodel.cn/api/paas/v4|GLM_API_KEY|智谱 GLM-4
  claude-231|deepseek-chat|https://api.deepseek.com/v1|DEEPSEEK_API_KEY|DeepSeek

项目地址: https://github.com/your-username/claude-code-command-switch
EOF
}

# 初始化
init() {
    mkdir -p "$INSTALL_DIR"
    mkdir -p "$COMMANDS_DIR"

    if [ ! -f "$CONFIG_FILE" ]; then
        cat > "$CONFIG_FILE" << 'EOF'
# claude-code-command-switch 模型配置文件
# 格式: COMMAND_NAME|MODEL_ID|API_ENDPOINT|API_KEY_ENV_VAR|DESCRIPTION

# 示例配置（取消注释并填写您的 API Key）
# claude-glm|glm-4|https://open.bigmodel.cn/api/paas/v4|GLM_API_KEY|智谱 GLM-4
# claude-231|deepseek-chat|https://api.deepseek.com/v1|DEEPSEEK_API_KEY|DeepSeek V3
# claude-gpt|gpt-4-turbo|https://api.openai.com/v1|OPENAI_API_KEY|GPT-4 Turbo
EOF
        info "已创建默认配置文件: $CONFIG_FILE"
    else
        info "配置文件已存在"
    fi
}

# 列出所有命令
list_commands() {
    echo ""
    echo -e "${BLUE}可用的 claude 模型命令:${NC}"
    echo ""

    if [ ! -f "$CONFIG_FILE" ] || [ ! -s "$CONFIG_FILE" ]; then
        warn "配置文件为空，请先添加模型配置"
        echo ""
        info "使用 'claude-switch edit' 编辑配置文件"
        return
    fi

    local count=0
    while IFS='|' read -r name model_id endpoint key_env desc || [ -n "$name" ]; do
        # 跳过注释和空行
        [[ "$name" =~ ^#.*$ ]] && continue
        [[ -z "$name" ]] && continue

        count=$((count + 1))

        # 检查命令是否已安装
        if [ -L "$BIN_DIR/$name" ] || [ -f "$BIN_DIR/$name" ]; then
            status="${GREEN}✓ 已安装${NC}"
        else
            status="${YELLOW}✗ 未安装${NC}"
        fi

        printf "  ${BLUE}%2d.${NC} %-20s ${GREEN}→${NC} %s\n" "$count" "$name" "$model_id"
        printf "     %-20s   %s\n" "" "$desc"
        printf "     %-20s   状态: %s\n" "" "$status"
        echo ""
    done < "$CONFIG_FILE"

    if [ $count -eq 0 ]; then
        warn "未找到任何模型配置"
        echo ""
        info "使用 'claude-switch edit' 编辑配置文件添加模型"
    fi
}

# 添加命令
add_command() {
    local name="$1"

    if [ -z "$name" ]; then
        error "请指定命令名称，例如: claude-switch add glm"
    fi

    # 检查配置文件中是否存在该模型
    if ! grep -q "^claude-$name|" "$CONFIG_FILE" 2>/dev/null; then
        error "未找到 claude-$name 的配置，请先在配置文件中添加"
    fi

    # 读取配置
    local line=$(grep "^claude-$name|" "$CONFIG_FILE")
    IFS='|' read -r cmd_name model_id api_endpoint key_env desc <<< "$line"

    info "正在安装命令: $cmd_name"
    echo "  模型: $model_id"
    echo "  接口: $api_endpoint"
    echo "  Key: $key_env"

    # 创建命令脚本
    local script_path="$COMMANDS_DIR/$cmd_name"

    cat > "$script_path" << EOF
#!/bin/bash
# Auto-generated by claude-code-command-switch
# Model: $model_id
# Endpoint: $api_endpoint

# 检查 API Key
if [ -z "\${$key_env}" ]; then
    echo "错误: 环境变量 $key_env 未设置"
    echo "请运行: export $key_env=your-api-key"
    exit 1
fi

# 设置环境变量并调用 claude
export ANTHROPIC_API_KEY="\${$key_env}"
export ANTHROPIC_BASE_URL="$api_endpoint"

exec claude "\$@"
EOF

    chmod +x "$script_path"

    # 创建符号链接
    ln -sf "$script_path" "$BIN_DIR/$cmd_name"

    info "命令 $cmd_name 安装成功！"
    echo ""
    echo "现在可以使用: $cmd_name \"你的问题\""
    echo "示例: $cmd_name \"帮我写一个 Python 脚本\""
}

# 删除命令
remove_command() {
    local name="$1"

    if [ -z "$name" ]; then
        error "请指定要删除的命令名称"
    fi

    local cmd_name="claude-$name"

    if [ ! -L "$BIN_DIR/$cmd_name" ] && [ ! -f "$BIN_DIR/$cmd_name" ]; then
        warn "命令 $cmd_name 不存在"
        return
    fi

    rm -f "$BIN_DIR/$cmd_name"
    rm -f "$COMMANDS_DIR/$cmd_name"

    info "命令 $cmd_name 已删除"
}

# 编辑配置文件
edit_config() {
    local editor="${EDITOR:-nano}"

    if [ ! -f "$CONFIG_FILE" ]; then
        init
    fi

    $editor "$CONFIG_FILE"

    info "配置文件已更新，请运行 'claude-switch list' 查看可用命令"
}

# 更新脚本
update_script() {
    info "正在更新 claude-code-command-switch..."

    cd "$INSTALL_DIR"

    local REPO_URL="https://raw.githubusercontent.com/your-username/claude-code-command-switch/main"

    curl -sSL "$REPO_URL/claude-switch" -o claude-switch.new
    curl -sSL "$REPO_URL/command-template.sh" -o command-template.sh.new

    mv claude-switch.new claude-switch
    mv command-template.sh.new command-template.sh

    chmod +x claude-switch
    chmod +x command-template.sh

    info "更新完成！"
}

# 主函数
main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        add)
            add_command "$@"
            ;;
        remove|rm)
            remove_command "$@"
            ;;
        list|ls)
            list_commands
            ;;
        edit|vi)
            edit_config
            ;;
        init)
            init
            ;;
        update)
            update_script
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            error "未知命令: $command\n使用 'claude-switch help' 查看帮助"
            ;;
    esac
}

main "$@"
